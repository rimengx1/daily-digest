const dailyContent = {
  date: "2026å¹´2æœˆ16æ—¥",
  dateEn: "February 16, 2026",
  rss: [
    {
      title: "GPT-5.2 åœ¨ç†è®ºç‰©ç†ä¸Šç»™å‡ºæ–°ç»“æœï¼ˆé¢„å°æœ¬ï¼‰",
      source: "OpenAI Blog",
      summary: "OpenAI ä»‹ç»äº†ä¸€ç¯‡é¢„å°æœ¬ï¼šGPT-5.2 æå‡ºä¸€ä¸ªå…³äºèƒ¶å­æ•£å°„æŒ¯å¹…çš„å…¬å¼ï¼Œéšåç”±å†…éƒ¨æ¨¡å‹ä¸ä½œè€…ä¾§éªŒè¯ï¼Œè®ºæ–‡å·²ä¸Š arXiv å¹¶æŠ•ç¨¿ä¸­",
      url: "https://openai.com/index/new-result-theoretical-physics/?utm_source=chatgpt.com",
      time: "10:00"
    },
    {
      title: "ChatGPT å¼•å…¥é”å®šæ¨¡å¼ä¸é«˜é£é™©èƒ½åŠ›æ ‡ç­¾",
      source: "OpenAI Blog",
      summary: "é¢å‘é«˜é£é™©ç”¨æˆ·/ç»„ç»‡ï¼ˆå¦‚é«˜ç®¡ã€å®‰å…¨å›¢é˜Ÿï¼‰çš„å¯é€‰å®‰å…¨è®¾ç½®ï¼šé€šè¿‡æ›´å¼ºçº¦æŸæ¥é™ä½æç¤ºæ³¨å…¥å¯¼è‡´çš„æ•°æ®å¤–æ³„é£é™©ï¼Œå¹¶å¯¹æŸäº›é«˜é£é™©èƒ½åŠ›åŠ å¯è§æ ‡ç­¾",
      url: "https://openai.com/index/introducing-lockdown-mode-and-elevated-risk-labels-in-chatgpt/?utm_source=chatgpt.com",
      time: "09:00"
    },
    {
      title: "GPT-5.3-Codex-Sparkï¼šé¢å‘å®æ—¶ç¼–ç çš„è¶…ä½å»¶è¿Ÿæ¨¡å‹",
      source: "OpenAI Blog",
      summary: "ä¸»æ‰“å®æ—¶åä½œå†™ä»£ç ï¼Œå®£ç§°å¯è¾¾1000+ tokens/sã€128k ä¸Šä¸‹æ–‡ã€æ–‡æœ¬-onlyï¼›é€šè¿‡ WebSocket ç­‰ä¼˜åŒ–æŠŠç«¯åˆ°ç«¯å»¶è¿Ÿæ˜¾è‘—å‹ä½ï¼Œä¸”ç”± Cerebras ç¡¬ä»¶æ”¯æ’‘",
      url: "https://openai.com/zh-Hans-CN/index/introducing-gpt-5-3-codex-spark/?utm_source=chatgpt.com",
      time: "08:00"
    },
    {
      title: "Codex / Sora çš„è®¿é—®æ§åˆ¶å‡çº§",
      source: "OpenAI Blog",
      summary: "OpenAI å·¥ç¨‹å‘æ–‡ç« è§£é‡Šä¸ºä½•å•çº¯æé«˜ rate limit æˆ–çº¯æŒ‰é‡è®¡è´¹éƒ½ä¸å¤Ÿï¼Œå¹¶ç”¨å®æ—¶é™æµè§¦é¡¶åæ— ç¼åˆ‡é¢åº¦çš„æ··åˆæ¨¡å‹æ¥æ‰©å®¹ä½“éªŒä¸å…¬å¹³æ€§",
      url: "https://openai.com/index/beyond-rate-limits/?utm_source=chatgpt.com",
      time: "07:00"
    }
  ],
  ai: [
    {
      title: "é»‘çŸ³åŠ ç å°åº¦æœ¬åœŸ AI ç®—åŠ›ï¼ŒNeysa è®¡åˆ’æœ€é«˜ 12 äº¿ç¾å…ƒèèµ„",
      source: "TechCrunch",
      summary: "é»‘çŸ³åŠå…±åŒæŠ•èµ„æ–¹æ‹Ÿå‘å°åº¦ AI åŸºç¡€è®¾æ–½å…¬å¸ Neysa æŠ•å…¥æœ€é«˜ 6 äº¿ç¾å…ƒè‚¡æƒå¹¶æ¨åŠ¨å…¶å†èèµ„ 6 äº¿ç¾å…ƒå€ºåŠ¡ï¼›å…¬å¸ GPU è§„æ¨¡ä»çº¦ 1,200 è®¡åˆ’æ‰©å¼ åˆ° 20,000+",
      url: "https://techcrunch.com/2026/02/15/blackstone-backs-neysa-in-up-to-1-2b-financing-as-india-pushes-to-build-domestic-ai-compute/?utm_source=chatgpt.com"
    },
    {
      title: "Googleï¼šé’ˆå¯¹ Gemini çš„æ¨¡å‹è’¸é¦/æŠ½å–æ”»å‡»å¢å¤šï¼Œå‡ºç° 10 ä¸‡+ æç¤ºè¯è§„æ¨¡æ¡ˆä¾‹",
      source: "Google Cloud",
      summary: "Google Threat Intelligence Group æŠ¥å‘Šï¼šè§‚å¯Ÿåˆ°æ›´å¤šå°† AI ç”¨äºæ”»å‡»é“¾æ¡çš„è¡Œä¸ºï¼Œå¹¶æŠ«éœ²ä¸€ç±»é€¼å‡ºæ¨ç†ç—•è¿¹çš„æŠ½å–æ”»å‡»æ¡ˆä¾‹ï¼Œè§„æ¨¡è¾¾åˆ° 10 ä¸‡+ prompts",
      url: "https://cloud.google.com/blog/topics/threat-intelligence/distillation-experimentation-integration-ai-adversarial-use?utm_source=chatgpt.com"
    },
    {
      title: "AI å£°éŸ³åˆèµ·è¯‰è®¼ï¼šNPR ä¸»æ’­å°± NotebookLM è¯­éŸ³æå‘Š Google",
      source: "Washington Post",
      summary: "ä¸€ä½é•¿æœŸ NPR ä¸»æ’­èµ·è¯‰ Googleï¼ŒæŒ‡æ§å…¶åœ¨ NotebookLM é‡Œä½¿ç”¨äº† AI è¯­éŸ³ä¸”æœªç»åŒæ„ï¼›è¿™ç±»æ¡ˆä»¶é€šå¸¸ä¼šæŠŠç„¦ç‚¹æ‹‰åˆ°å£°éŸ³æƒ/æˆæƒã€è®­ç»ƒä¸åˆæˆè¾¹ç•Œä¸Š",
      url: "https://www.washingtonpost.com/technology/2026/02/15/google-notebooklm-ai-voice-lawsuit-npr/"
    }
  ],
  thoughts: [
    { content: "[è§‚ç‚¹] @sama: AI is changing everything. New models coming soon.", time: "åˆšåˆš" },
    { content: "[æŠ€æœ¯] @karpathy: New neural architecture shows 2x efficiency gains.", time: "5åˆ†é’Ÿå‰" },
    { content: "[è§‚ç‚¹] @ylecun: Open source AI is the only way forward for safety.", time: "10åˆ†é’Ÿå‰" },
    { content: "[æŠ€æœ¯] @DrJimFan: Embodied AI breakthrough: robot learned to fold clothes.", time: "15åˆ†é’Ÿå‰" },
    { content: "[æ•™è‚²] @jeremyphoward: Fast.ai new course on LLM fine-tuning is live.", time: "20åˆ†é’Ÿå‰" }
  ],
  rec: [
    {
      title: "Agent å‡çº§ç¿»è½¦å®å½•ï¼šç°å®çš„åº•å±‚é€»è¾‘æ˜¯æ¦‚ç‡åˆ†å¸ƒ",
      source: "x/@xxx111god",
      summary: "ç°å®çš„åº•å±‚é€»è¾‘æ˜¯æ¦‚ç‡åˆ†å¸ƒï¼ŒAI agent ä¹Ÿä¸ä¾‹å¤–ã€‚ç¡å‰è®© Agent è‡ªå·±å‡çº§ï¼Œæ—©ä¸Šå‘ç°å®šæ—¶ä»»åŠ¡å…¨æ²¡è·‘ï¼Œç³»ç»Ÿè¿›å…¥å‡çº§å¤±è´¥å¾ªç¯ã€‚",
      url: "https://x.com/xxx111god/status/2022352959133151433"
    },
    {
      title: "å’¸é±¼æ™ºèƒ½ç›‘æ§ - é’ˆå¯¹é—²é±¼å¹³å°çš„ AI è‡ªåŠ¨åŒ–ç›‘æ§å·¥å…·",
      source: "GitHub",
      summary: "å…³é”®è¯ç›‘æ§ã€ä»·æ ¼å˜åŒ–æ•æ‰ã€è‡ªåŠ¨åŒ–è¿è¡Œï¼ŒæŠŠåˆ·åˆ—è¡¨çš„æ—¶é—´äº¤ç»™å·¥å…·ã€‚",
      url: "https://github.com/Usagi-org/ai-goofish-monitor"
    },
    {
      title: "OpenClaw Token èŠ‚çº¦ç»ˆææŒ‡å—ï¼šç”¨æœ€å¼ºæ¨¡å‹ï¼ŒèŠ±æœ€å°‘çš„é’±",
      source: "x/@ohxiyu",
      summary: "åˆ†æ token éšæ€§æˆæœ¬ï¼šç³»ç»Ÿæç¤ºã€ä¸Šä¸‹æ–‡æ³¨å…¥ã€å†å²æ¶ˆæ¯åœ¨ cron å’Œ heartbeat åœºæ™¯ä¸‹ä¼šå¯¼è‡´é¢„ç®—å¿«é€Ÿæ”¾å¤§ã€‚",
      url: "https://x.com/ohxiyu/status/2020131912149508338"
    }
  ],
  archive: [
    {
      date: "2026å¹´2æœˆ15æ—¥",
      dateEn: "February 15, 2026",
      rss: [
        {
          title: "The great computer science exodus",
          source: "TechCrunch",
          summary: "Students losing interest in CS but gaining interest in AI-specific majors",
          url: "https://techcrunch.com/2026/02/15/the-great-computer-science-exodus/"
        }
      ],
      ai: [],
      thoughts: [],
      rec: []
    }
  ]
};

const SUMMARY_CACHE_KEY = "dailyDigest_aiSummaryCache_v1";
const SUMMARY_CACHE_TTL = 24 * 60 * 60 * 1000;
let currentLang = "zh";
const allArticles = [];
const inFlightSummaryRequests = new Map();

document.addEventListener("DOMContentLoaded", () => {
  const savedLang = localStorage.getItem("dailyDigest_lang");
  if (savedLang) currentLang = savedLang;

  renderAll();
  initNav();
  initTheme();
  initGlobalActions();
});

function renderAll() {
  const isEn = currentLang === "en";
  const dateA = document.getElementById("currentDate");
  const dateB = document.getElementById("currentDate2");

  if (dateA) dateA.textContent = isEn ? dailyContent.dateEn : dailyContent.date;
  if (dateB) dateB.textContent = isEn ? dailyContent.dateEn : dailyContent.date;

  allArticles.length = 0;
  let indexCounter = 0;
  indexCounter = renderList("rssArticlesContent", dailyContent.rss, "rss", indexCounter);
  indexCounter = renderList("aiNewsContent", dailyContent.ai, "ai", indexCounter);
  renderThoughts();
  renderList("recommendationsContent", dailyContent.rec, "rec", indexCounter);
  renderArchive();

  hydrateArticleInteractions();
  runMotionAnimations();
}

function renderList(containerId, items, type, startIndex = 0) {
  const container = document.getElementById(containerId);
  const isEn = currentLang === "en";
  if (!container) return startIndex;

  if (!items.length) {
    container.innerHTML = `<div class="empty-state">${isEn ? "No content" : "æš‚æ— å†…å®¹"}</div>`;
    return startIndex;
  }

  container.innerHTML = items
    .map((item, idx) => {
      const articleId = `${type}-${idx}`;
      const globalIndex = startIndex + idx + 1;
      const heatData = buildHeatData(item.title);
      const articleRecord = {
        id: articleId,
        type,
        index: globalIndex,
        title: item.title || "",
        summary: item.summary || "",
        source: item.source || "",
        url: item.url || "",
        time: item.time || "",
        heatData,
        tokens: buildTokens(`${item.title || ""} ${item.summary || ""}`)
      };
      allArticles.push(articleRecord);

      const heatTag = heatData.oneHourGrowth > 50 ? '<span class="heat-hot">ğŸ”¥</span>' : "";
      const summaryBlock = `
        <div class="summary-tabs-wrap">
          <div class="summary-tabs">
            <button class="summary-tab chip active" data-article-id="${articleId}" data-mode="quick">âš¡30ç§’é€Ÿè¯»</button>
            <button class="summary-tab chip" data-article-id="${articleId}" data-mode="standard">ğŸ“„æ ‡å‡†æ‘˜è¦</button>
            <button class="summary-tab chip" data-article-id="${articleId}" data-mode="simple">ğŸ‘¶å°ç™½è§£é‡Š</button>
          </div>
          <div class="summary-content" id="summary-${articleId}">${escapeHtml(item.summary || "")}</div>
        </div>
      `;

      const trendTooltip = `
        <div class="trend-tooltip">
          <div class="trend-title">24h Trend</div>
          <svg class="trend-sparkline" viewBox="0 0 120 36" preserveAspectRatio="none">
            <polyline points="${getSparklinePoints(heatData.series)}"></polyline>
          </svg>
          <div class="trend-meta">${heatData.series[0]} â†’ ${heatData.series[23]} (${Math.round(heatData.oneHourGrowth)}%)</div>
        </div>
      `;

      return `
        <article class="article-card" data-article-id="${articleId}" style="position: relative;">
          <span class="article-number">#${globalIndex}</span>
          <div class="article-header">
            <div class="article-title">${escapeHtml(item.title || (isEn ? "Untitled" : "æ— æ ‡é¢˜"))}</div>
          </div>
          <div class="article-meta">
            ${item.source ? `<span class="article-source">${escapeHtml(item.source)}</span>` : ""}
            ${item.time ? `<span class="article-date">${escapeHtml(item.time)}</span>` : ""}
            <span class="heat-score-wrap">
              <span class="chip heat-score">çƒ­åº¦ ${heatData.current}${heatTag}</span>
              <button type="button" class="trend-icon" aria-label="æŸ¥çœ‹çƒ­åº¦è¶‹åŠ¿">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 17l5-6 4 3 6-8"></path>
                  <path d="M19 6h-4"></path>
                </svg>
              </button>
              ${trendTooltip}
            </span>
          </div>
          ${summaryBlock}
          ${item.url ? `<div class="article-footer"><a href="${escapeHtml(item.url)}" target="_blank" rel="noreferrer noopener" class="article-link">${isEn ? "Read more ->" : "é˜…è¯»å…¨æ–‡ ->"}</a></div>` : ""}
        </article>
      `;
    })
    .join("");

  return startIndex + items.length;
}

function renderThoughts() {
  const container = document.getElementById("thoughtsContent");
  const isEn = currentLang === "en";
  if (!container) return;

  if (!dailyContent.thoughts.length) {
    container.innerHTML = `<div class="empty-state">${isEn ? "No thoughts" : "æš‚æ— å†…å®¹"}</div>`;
    return;
  }

  container.innerHTML = dailyContent.thoughts
    .map(
      (item) => `
      <div class="thought-card">
        <div class="thought-content">${escapeHtml(item.content || "")}</div>
        <div class="thought-time">${escapeHtml(item.time || "")}</div>
      </div>
    `
    )
    .join("");
}

function renderArchive() {
  const container = document.getElementById("archiveList");
  if (!container) return;

  const isEn = currentLang === "en";
  const archive = dailyContent.archive || [];
  if (!archive.length) {
    container.innerHTML = `<div class="empty-state">${isEn ? "No archive" : "æš‚æ— å†å²å†…å®¹"}</div>`;
    return;
  }

  container.innerHTML = archive
    .map(
      (item) => `
      <div class="archive-item">
        <div class="archive-date">${isEn ? escapeHtml(item.dateEn || "") : escapeHtml(item.date || "")}</div>
        <div class="archive-count">RSS: ${item.rss?.length || 0} | AI: ${item.ai?.length || 0} | æ¨è: ${item.rec?.length || 0}</div>
      </div>
    `
    )
    .join("");
}

function hydrateArticleInteractions() {
  document.querySelectorAll(".summary-tab").forEach((tab) => {
    tab.addEventListener("click", async (event) => {
      event.stopPropagation();
      const { articleId, mode } = tab.dataset;
      if (!articleId || !mode) return;

      const group = tab.closest(".summary-tabs");
      if (group) group.querySelectorAll(".summary-tab").forEach((btn) => btn.classList.remove("active"));
      tab.classList.add("active");

      const target = document.getElementById(`summary-${articleId}`);
      if (!target) return;
      const article = allArticles.find((entry) => entry.id === articleId);
      if (!article) return;

      target.textContent = currentLang === "en" ? "Generating..." : "ç”Ÿæˆä¸­...";
      const text = await getSmartSummary(article, mode);
      target.textContent = text;
    });
  });

  document.querySelectorAll(".article-card").forEach((card) => {
    card.addEventListener("click", (event) => {
      if (event.target.closest("a,button")) return;
      const articleId = card.dataset.articleId;
      const article = allArticles.find((entry) => entry.id === articleId);
      if (article) openDetailModal(article);
    });
  });
}

async function getSmartSummary(article, mode) {
  const cacheKey = buildSummaryCacheKey(article, mode);
  const cache = getSummaryCache();
  const cached = cache[cacheKey];
  if (cached && cached.expireAt > Date.now()) {
    return cached.text;
  }

  if (inFlightSummaryRequests.has(cacheKey)) {
    return inFlightSummaryRequests.get(cacheKey);
  }

  const promise = requestSummaryFromOpenAI(article, mode)
    .then((text) => {
      cache[cacheKey] = {
        text,
        expireAt: Date.now() + SUMMARY_CACHE_TTL
      };
      setSummaryCache(cache);
      return text;
    })
    .catch(() => fallbackSummary(article, mode))
    .finally(() => {
      inFlightSummaryRequests.delete(cacheKey);
    });

  inFlightSummaryRequests.set(cacheKey, promise);
  return promise;
}

async function requestSummaryFromOpenAI(article, mode) {
  const key = localStorage.getItem("dailyDigest_openai_api_key");
  if (!key) return fallbackSummary(article, mode);

  const modePrompts = {
    quick: "è¯·è¾“å‡ºçº¦2å¥ï¼Œæ§åˆ¶åœ¨30ç§’å¯è¯»å®Œï¼Œçªå‡ºæœ€å…³é”®ç»“è®ºä¸å½±å“ã€‚",
    standard: "è¯·è¾“å‡º4-5å¥æ ‡å‡†æ‘˜è¦ï¼ŒåŒ…å«èƒŒæ™¯ã€å…³é”®äº‹å®ã€å½±å“ã€‚",
    simple: "è¯·ç”¨å°ç™½èƒ½æ‡‚çš„æ–¹å¼è§£é‡Šï¼Œä¸è¶…è¿‡4å¥ï¼Œå¯ç±»æ¯”è¯´æ˜ã€‚"
  };

  const response = await fetch("https://api.openai.com/v1/responses", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${key}`
    },
    body: JSON.stringify({
      model: "gpt-4.1-mini",
      input: [
        {
          role: "system",
          content: "ä½ æ˜¯æ¯æ—¥èµ„è®¯ç¼–è¾‘ï¼Œè¾“å‡ºä¸­æ–‡ï¼Œç®€æ´ã€å‡†ç¡®ï¼Œä¸ç¼–é€ ã€‚"
        },
        {
          role: "user",
          content: `${modePrompts[mode]}\n\næ ‡é¢˜: ${article.title}\næ¥æº: ${article.source}\nåŸæ‘˜è¦: ${article.summary}`
        }
      ]
    })
  });

  if (!response.ok) {
    throw new Error("OpenAI request failed");
  }

  const data = await response.json();
  const text = data.output_text || "";
  return text.trim() || fallbackSummary(article, mode);
}

function fallbackSummary(article, mode) {
  const base = article.summary || article.title;
  if (!base) return "æš‚æ— æ‘˜è¦";
  if (mode === "quick") return `30ç§’é€Ÿè¯»ï¼š${base.slice(0, 72)}${base.length > 72 ? "..." : ""}`;
  if (mode === "simple") return `å°ç™½è§£é‡Šï¼šå¯ä»¥ç†è§£ä¸ºâ€œ${article.title}â€è¿™ä»¶äº‹ä¼šå½±å“è¡Œä¸šä¸‹ä¸€æ­¥å†³ç­–ï¼Œæ ¸å¿ƒæ˜¯ ${base.slice(0, 52)}${base.length > 52 ? "..." : ""}`;
  return `æ ‡å‡†æ‘˜è¦ï¼š${base}`;
}

function buildSummaryCacheKey(article, mode) {
  return `${article.id}:${mode}:${simpleHash(`${article.title}|${article.summary}`)}`;
}

function getSummaryCache() {
  try {
    const parsed = JSON.parse(localStorage.getItem(SUMMARY_CACHE_KEY) || "{}");
    const now = Date.now();
    Object.keys(parsed).forEach((key) => {
      if (!parsed[key] || parsed[key].expireAt <= now) delete parsed[key];
    });
    return parsed;
  } catch {
    return {};
  }
}

function setSummaryCache(cache) {
  localStorage.setItem(SUMMARY_CACHE_KEY, JSON.stringify(cache));
}

function buildHeatData(seedText) {
  const baseSeed = Math.abs(simpleHash(seedText));
  const start = 38 + (baseSeed % 32);
  const series = [];
  let current = start;
  for (let i = 0; i < 24; i += 1) {
    const stepSeed = Math.abs(simpleHash(`${seedText}-${i}`));
    const delta = (stepSeed % 11) - 4;
    current = clamp(current + delta, 20, 98);
    series.push(current);
  }

  const previousHour = Math.max(1, series[22]);
  const oneHourGrowth = ((series[23] - previousHour) / previousHour) * 100;
  return {
    series,
    current: series[23],
    oneHourGrowth
  };
}

function getSparklinePoints(series) {
  const min = Math.min(...series);
  const max = Math.max(...series);
  const spread = Math.max(1, max - min);

  return series
    .map((value, idx) => {
      const x = (idx / (series.length - 1)) * 120;
      const y = 32 - ((value - min) / spread) * 28;
      return `${x.toFixed(2)},${y.toFixed(2)}`;
    })
    .join(" ");
}

function openDetailModal(article) {
  const modal = document.getElementById("articleModal");
  if (!modal) return;

  const titleEl = document.getElementById("detailTitle");
  const metaEl = document.getElementById("detailMeta");
  const summaryEl = document.getElementById("detailSummary");
  const linkEl = document.getElementById("detailLink");
  const timelineEl = document.getElementById("detailTimeline");
  if (!titleEl || !metaEl || !summaryEl || !linkEl || !timelineEl) return;

  titleEl.textContent = article.title;
  metaEl.textContent = `${article.source}${article.time ? ` | ${article.time}` : ""}`;
  summaryEl.textContent = article.summary;
  linkEl.href = article.url || "#";
  linkEl.style.display = article.url ? "inline-block" : "none";

  const timeline = buildRelatedTimeline(article.id);
  timelineEl.innerHTML = timeline.length
    ? timeline
        .map(
          (node, idx) => `
      <div class="timeline-item ${idx === 0 ? "active" : ""}">
        <div class="timeline-dot"></div>
        <div class="timeline-content">
          <div class="timeline-title">${escapeHtml(node.title)}</div>
          <div class="timeline-meta">${escapeHtml(node.source)} ${node.time ? `| ${escapeHtml(node.time)}` : ""}</div>
        </div>
      </div>
    `
        )
        .join("")
    : `<div class="empty-state" style="padding: 20px 0;">æš‚æ— é«˜ç›¸ä¼¼åº¦å…³è”äº‹ä»¶</div>`;

  modal.classList.remove("hidden");
  if (window.Motion && window.Motion.animate) {
    window.Motion.animate(".detail-card", { opacity: [0, 1], y: [24, 0] }, { duration: 0.25, easing: "ease-out" });
  }
}

function buildRelatedTimeline(articleId) {
  const selected = allArticles.find((item) => item.id === articleId);
  if (!selected) return [];

  const related = allArticles.filter((item) => similarityScore(selected.tokens, item.tokens) >= 0.7);
  return related.sort((a, b) => parseTime(a.time) - parseTime(b.time));
}

function parseTime(text) {
  if (!text || !/^\d{2}:\d{2}$/.test(text)) return 9999;
  const [h, m] = text.split(":").map(Number);
  return h * 60 + m;
}

function similarityScore(aTokens, bTokens) {
  if (!aTokens.size || !bTokens.size) return 0;
  let intersection = 0;
  aTokens.forEach((token) => {
    if (bTokens.has(token)) intersection += 1;
  });
  return intersection / Math.min(aTokens.size, bTokens.size);
}

function buildTokens(text) {
  const tokens = new Set();
  const normalized = (text || "").toLowerCase().replace(/[^\p{L}\p{N}\s]/gu, " ");

  normalized
    .split(/\s+/)
    .filter((word) => word.length >= 2)
    .forEach((word) => tokens.add(word));

  const cnMatches = normalized.match(/[\u4e00-\u9fff]{2,}/g) || [];
  cnMatches.forEach((chunk) => {
    for (let i = 0; i < chunk.length - 1; i += 1) {
      tokens.add(chunk.slice(i, i + 2));
    }
  });

  return tokens;
}

function initNav() {
  document.querySelectorAll(".nav-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const section = btn.dataset.section;
      document.querySelectorAll(".nav-btn").forEach((item) => item.classList.remove("active"));
      btn.classList.add("active");
      document.querySelectorAll(".section").forEach((sectionEl) => sectionEl.classList.remove("active"));
      if (section) document.getElementById(section)?.classList.add("active");
      runMotionAnimations();
    });
  });

  const langToggle = document.getElementById("langToggle");
  if (langToggle) {
    langToggle.textContent = currentLang === "zh" ? "EN/ä¸­" : "ä¸­/EN";
    langToggle.addEventListener("click", () => {
      currentLang = currentLang === "zh" ? "en" : "zh";
      localStorage.setItem("dailyDigest_lang", currentLang);
      langToggle.textContent = currentLang === "zh" ? "EN/ä¸­" : "ä¸­/EN";
      renderAll();
    });
  }
}

function initTheme() {
  const savedTheme = localStorage.getItem("dailyDigest_theme");
  if (savedTheme) {
    document.documentElement.setAttribute("data-theme", savedTheme);
  }

  const themeToggle = document.getElementById("themeToggle");
  if (!themeToggle) return;
  themeToggle.addEventListener("click", () => {
    const current = document.documentElement.getAttribute("data-theme");
    const next = current === "dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", next);
    localStorage.setItem("dailyDigest_theme", next);
  });
}

function initGlobalActions() {
  const setApiKeyBtn = document.getElementById("setApiKey");
  if (setApiKeyBtn) {
    setApiKeyBtn.addEventListener("click", () => {
      const previous = localStorage.getItem("dailyDigest_openai_api_key") || "";
      const input = window.prompt("è¾“å…¥ OpenAI API Keyï¼ˆä»…æœ¬åœ° localStorage ä¿å­˜ï¼‰", previous);
      if (input && input.trim()) {
        localStorage.setItem("dailyDigest_openai_api_key", input.trim());
      }
    });
  }

  const modal = document.getElementById("articleModal");
  if (modal) {
    modal.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      if (target.dataset.closeModal === "true" || target.id === "closeDetail") {
        modal.classList.add("hidden");
      }
    });
  }
}

function runMotionAnimations() {
  if (!window.Motion || !window.Motion.animate || !window.Motion.stagger) return;
  window.Motion.animate(
    ".section.active .article-card, .section.active .thought-card, .section.active .archive-item",
    { opacity: [0, 1], y: [14, 0] },
    { delay: window.Motion.stagger(0.035), duration: 0.22, easing: "ease-out" }
  );
}

function simpleHash(text) {
  let hash = 0;
  for (let i = 0; i < text.length; i += 1) {
    hash = (hash << 5) - hash + text.charCodeAt(i);
    hash |= 0;
  }
  return hash;
}

function clamp(value, min, max) {
  return Math.min(max, Math.max(min, value));
}

function escapeHtml(value) {
  return String(value)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}
